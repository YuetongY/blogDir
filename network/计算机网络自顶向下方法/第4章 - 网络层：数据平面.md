# 第4章 - 网络层：数据平面

网络层能够被分解为像个相互作用的部分：数据平面和控制平面

## 4.1 网络层概述

### 4.1.1 转发和路由选择：数据平面和控制平面

两种重要的网络层功能：

- 转发：是数据平面中实现的唯一功能。是指将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作。转发发生的时间尺度很短（通常为几纳秒），因此通常用硬件来实现。

- 路由选择：在控制平面中实现。是指确定分组从源到目的地所采取的端到端路径的网络范围处理过程。路由选择发生的时间尺度长的多（通常为几秒），因此通常用软件来实现。

控制平面常用方法有：

- 传统的方法：路由选择算法运行在每台路由器中，并且每台路由器中都包含转发和路由选择两种功能。路由选择算法与其他路由器中的路由选择算法通信，以计算出它的转发表的值。

- SDN 方法：远程控制器计算和分发转发表以供每台路由器所使用。控制平面路由选择功能与物理的路由器是分离的，即路由选择设备仅执行转发，而远程控制器计算并分发转发表。

## 4.2 路由器工作原理

如下是一个通用路由器体系结构的总体视图：

![2](http://ww1.sinaimg.cn/large/006alGmrly1g2qsjflul1j31410k4ald.jpg)

- 输入端口：执行终结入物理链路的物理层功能。与位于链路远端的数据链路层交互来执行数据链路层功能。执行查找功能

- 交换结构：将路由器的输入端口连接到它的输出端口。（注意：这里的“端口”一次，指的是路由器的物理输入和输出接口）

- 输出端口：存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组

- 路由选择处理器：执行控制平面功能

路由器的输入端口、输出端口和交换结构几乎总是用硬件实现。

转发分为：基于目的地转发和通用转发

## 4.3 网际协议：IPv4、寻址、IPv6 及其他

### 4.3.1 IPv4 数据报格式

![2](http://ww1.sinaimg.cn/large/006alGmrly1g2rasr44fej30xu0l3x11.jpg)

首部一共大小为 20 字节

- 版本号：如 IPv4 和 IPv6，占4比特

- 首部长度：4 比特

- 服务类型：低延时、高吞吐量、可靠性、实时、非实时等

- 数据报长度：IP 数据报，占16比特，所以数据报的理论最大长度为 65535 字节

- 标识、标志、片偏移：与 IP 分片有关。将大的数据报切为片，适应不同的承载最大数据量的链路层帧

- 协议：指定数据报交给哪个特定的运输层协议

- 首部校验和：帮助路由器检测收到的 IP 数据报中的比特错误

- 源和目的 IP 地址：

- 选项：允许 IP 首部被扩展

- 数据（有效载荷）：包含交付给目的地的运输层报文段

### 4.3.2 IPv4 数据报分片

由于不同链路层协议中链路层帧能承载的最大数据量（最大传送单元）不同，所以 IP 数据报的长度受到了严格的限制。

为了将过大的 IP 分组挤进链路层帧的有效载荷字段，我们需要将 IP 数据报中的数据分片成两个或更小的 IP 数据报，用单独的链路层帧封装这些较小的 IP 数据报，然后通过数据链路发送这些帧。每个这些较小的数据报都称为 `片`

片在到达目的地运输层以前需要重新组装。数据报的重新组装工作在端系统中，而不是网络路由器中。`标识、标志和片偏移字段` 用于辅助完成组装工作

### 4.3.3 IPv4 编址

IP 地址长度为： 32 比特，因此总共有大约 40 亿个可能的 IP 地址

子网：如 223.1.1.0/24，其中 /24 称为 `子网掩码`。给定的子网上的所有设备都具有相同的子网地址。

因特网的地址分配策略被称为： `无类别域间路由选择` （Classless Interdomain Routing，CIDR）

形式为 a. b. c. d/x 的地址，前 x 位称为该地址的前缀（网络前缀）。剩余的 32 - x 比特用于该组织内部设备。

分类编址：分为 A、B 和 C 类网络。C 类网络（/24）子网仅能容纳 2^8 -2 = 254 台主机

IP 广播地址 255.255.255.255：用于将报文传播给同网络中的所有主机

动态主机配置协议（Dynamic Host Configuration，DHCP）：分配主机 IP 地址。又称 `即插即用协议` 或 `零配置协议`。此外它还是一个 `客户 - 服务器协议`。

### 4.3.4 网络地址转换

网络地址转换（Network Address Translation，NAT）：对外界如同一个具有单一 IP 地址的单一设备。其能使路由器对外界隐藏家庭网络的细节。

路由器从 ISP 的 DHCP 服务器得到它的地址，并且路由器运行一个 DHCP 服务器，为位于 NAT - DHCP 路由器控制的家庭网络地址空间中的计算机提供地址。

NAT 路由器会维护一张 `NAT 转换表`，表项中包含了端口号及其 IP 地址

### 4.3.5 IPv6

![2](http://ww1.sinaimg.cn/large/006alGmrly1g2rryhtbofj30rn0dwwmg.jpg)

## 4.4 通用转发和 SDN

通用转发不同于传统转发仅仅基于分组的目的地址，它能够对协议栈的多个首部字段进行“匹配”。可能进行的动作有：转发、丢弃和修改字段等。

通用转发中的设备描述为 “分组交换机” ，而不是第三层的 “路由器”，或第二层的 “交换机”。

分组交换机中的匹配加动作表，由远程控制器计算、安装和更新。