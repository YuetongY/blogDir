# 丁博老师 第7章 Part2:原理 第五讲:走向数据中心 --大规模服务端软件架构与公共服务

## 1. 大规模服务端软件架构

### 1.1 服务端软件架构

- 我们需要引入什么?
    1. 分层 • 前后分离,沉淀共性机制
    2. 分割 • 将单体应用按功能进行分割
    3. 集群 • 多台服务器部署相同应用
    4. 缓存 • 分布环境下解决数据访问瓶颈
    5. 异步 • 将同步调用转为异步消息
    6. 冗余 • 通过热备和冷备提高可用性
    7. 演化 • 持续在线监控和主动调整

### 1.2 服务端软件架构演化 step1

- 早期架构面临的烦恼

    1. 服务端程序越来越复杂,很难扩展
    2. 越来越多的用户访问导致性能越来越差
    3. 越来越多的数据导致存储空间不足

### 1.3 服务端软件架构演化 step2

- 分层和独立部署
    1. 表现层、业务逻辑层、数据层分离
    2. 引入应用服务器支持表现层和业务逻辑层运行
    3. 应用、文件和数据库服务器物理分离,提高性能
- 典型解决方案:LAMP

- 单台应用服务器无法满足需求

### 1.4 服务端软件架构演化 step3

- 引入应用服务器集群
    1. 负载均衡服务:将用户请求分发到集群的各个服务器上,并尽量保持各个服务器负载基本一致

- 问题:数据库成为瓶颈
    1. 实现数据库读写分离
        - 最简单的数据库集群,利用数据主从备份机制
        - 主服务器用于写数据,从服务器用于读数据
        - 引入专门的访问层,使读写分离对上层透明

### 1.5 服务端软件架构演化 step5

- 问题:后端数据访问仍是瓶颈
    1. 引入缓存服务
        - 缓存服务:在内存中放置热点数据,避免访问数据库

### 1.6 服务端软件架构演化 step6

- 继续提升后端数据访问能力
    1. 引入分布式数据库、分布式文件系统和分布式缓存

### 1.7 服务端软件架构演化 step7

- 从靠近用户的“前端”能否加速?
    1. 网面中大量静态资源不会变化,可以放到离用户很近的缓存时
    2. 避免访问后端文件服务器和数据库服务器

- 方式1:内容分发网络Content Delivery Network
    1. 将内容发布到最接近用户的网络“边缘“(如各地电信机房)
    2. 使用户可以就近取得所需的内容

- 方式2:反向代理

- 从靠近用户的“前端”加速
    1. 引入前端缓存

### 1.8 服务端软件架构演化 step8

- 问题:业务逻辑又成为瓶颈
    1. 运行:集群不是可以无限扩展的
    2. 开发和管理:规模的扩展也要求“分而治之”
- 业务拆分
    1. 各种服务间交互方式
- 从单数据中心到多数据中心
    1. 容灾备份,提高性能
    2. 常见方案
        - 双运营中心
        - 双活数据中心
        - 两地三中心
        - 分布式多活数据中心

## 2. 服务端软件的计算环境(支撑服务端软件的计算环境)

- 公共服务
    1. 消息服务
    2. 负载均衡服务
    3. 缓存服务
    4. 事务处理服务
    5. 目录服务
    6. 共享存储服务
    7. 大数据计算框架

### 2.1 案例:分布式日志

- 日志(Log)
    1. 将指定信息输出到文件或控制台

- 我们需要“解耦+限流”
    1. 将同步调用变成异步调用,去耦合
    2. 引入中间服务缓冲来不及处理的日志

### 2.2 消息服务

- 消息服务为分布式应用提供高效、灵活的消息传输机制,以及基于消息的交互支持
    1. 消息是一组良定义的结构化数据
    2. 具有“发送后不管”的异步特点,区别于“请求-应答”同步机制
    3. 异构软硬件平台之间可以通过消息互操作
- 消息服务交互模型
    1. 点对点模型
        时间解耦:消息的发送者和接收者无需同时在线,天然实现异步调用
    2. 发布订阅模型
        时空解耦:消息的发布者不需要知道有哪些订阅者,订阅者无需了解消息是由谁发布的,发布者和订阅者也无需同时在线

#### 2.2.1 案例1:CORBA的事件和通告服务

- 通告服务支持三种事件类型:
    1. Any类型:
        - 事件内容不为通道所知,与事件服务向后兼容。
    2. 结构类型
        - 定义了一个良好的数据结构,包含事件类型、QoS控制需求、事件过滤信息等方面内容。
    3. 序列类型
        - structured事件的序列化类型,提高通讯效率

对于后二者,依照一定语法,描述过滤条件,形成过滤
对象,可对事件发送者提供的事件和事件接收者接收的
事件进行过滤。

- QoS(Quality of Service)控制
    1. 通过对事件通道、事件设置QoS属性和其它管理属性,实现对事件传输持久性、事件队列长度、事件生命周期等服务质量的控制。
    2. 事件通讯的QOS可以在事件通道、admin对象和proxy对象三级进行设置
    3. structured事件也可以在变长事件头部分为每个事件设置QOS。

#### 2.2.2 案例2:Apache Kafka

- 大规模发布/订阅消息队列
    1. 最早由Linkedin研发,于2011年初开源
    2. 高效处理实时流式数据
    3. 可以实现与Storm、HBase和Spark的集成

### 2.3 负载均衡服务

#### 2.3.1 如何水平扩展

- 方式1:不同功能物理分离

- 方式2:单一功能集群扩展

    1. 将相同的功能部署在多台服务器上,构成一个集群对外提供服务

#### 2.3.2 负载均衡算法

- 目标:把负载合理地分配到集群中的节点上,充分利用
服务器资源,减少访问瓶颈并提高并发访问数量
    1. 最简单的是随机选择和轮询
    2. 复杂算法将考虑其它更多的相关因素
        - 如每台服务器负载、响应时间、运行状态、活动连接数、地理位置、处理能力、最近分配的流量、负载预测、会话粘滞(Sticky Session)等

- 静态算法
    1. 轮询(Round Robin)
        - 可能服务器并不完全一样,导致实际负载并不均衡
    2. 加权轮询(Weighted Round Robin)
        - 根据服务器配置和性能在轮询过程中增
    3. 权值随机(Random)
        - 相比轮询法性能略优,但需要大量请求才能均衡
    4. 加权随机(Weighted Random)
        - 根据服务器配置和性能在随机分配过程中增加权值

- 动态算法
    1. 最小连接(Least Connections)
        - 把请求调度到连接数量最小的服务器上
    2. 加权最小连接(Weighted Least Connections)
        - 给每台服务器一个权值,调度器会尽可能保持服务器连接数量与权值之间的平衡
    3. 源地址散列(Source Hashing)
        - 通过散列函数将源IP与服务器建立映射关系
        - 在服务器列表不变的情况下,每次客户端访问的服务器都是同一个服务器.利用这个特性可以有状态的session会话

#### 2.3.3 实现方式

- 具体形态
    1. 硬件、软件
- 工作层次
    1. 基于代理的负载均衡
    2. 基于重定向的负载均衡
    3. 基于DNS的负载均衡
    4. IP负载均衡
    5. 数据链接路层负载均衡

##### 2.3.3.1 实现1:基于代理的负载均衡

- 负载均衡器代理应用层请求
    1. 根据算法请请求分发到集群服务器上
    2. 可以HTTP反向代理等整合

##### 2.3.3.2 实现2:基于重定向的负载均衡

- 负载均衡器重定向请求,告知客户真实服务器IP地址
    1. 需要使用应用协议层重定向机制,实现用户透明
    2. 如HTTP 302CORBA::LocationForward

##### 2.3.3.3 实现3:DNS负载均衡

- 使用DNS域名解析服务器实现负载均衡
    1. 适用于广域网、基于域名的访问(如网页浏览)
    2. 通常与其它负载均衡技术综合使用

##### 2.3.3.4 实现4:IP负载均衡

- 在网络层通过修改目标地址进行负载均衡
    1. 与应用无关,在操作系统内核层工作

##### 2.3.3.5 实现5:数据链路层负载均衡

- 在数据链路层通过修改mac地址来实现负载均衡
    1. 应答消息无需通过负载均衡器

##### 2.3.3.6 实现6:多级负载均衡

- 通过使用多个不同类型/多个级别的负载均衡器来提高集群能力

#### 2.3.4 案例1:LVS Linux Virtual Server

- 虚拟服务器集群系统
    1. 使用集群技术和Linux操作系统实现一个
高性能、高可用的服务器
    2. 具有很好的可伸缩性(Scalability)、
可靠性(Reliability)和可管理(Manageability)
- 1998年5月由章文嵩创建
    1. 中国最早出现的开源软件项目之一
    2. Linux2.4以后内核的一部分

### 2.4 分布式缓存服务

- 缓存
    1. 用于存储部分数据的硬件或软件,以使得后续更快访问这些数据
    2. 广泛应用于传统计算机架构,如CPU Cache、硬盘Cache...

#### 2.4.1 分布式软件系统中的缓存

- 从位置分类

    1. 浏览器页面缓存
    2. 客户端缓存
    3. 内容传递网络CDN
    4. 正向代理缓存
    5. 反向代理缓存
    6. 语言/平台级本地缓存 Ehcache、Jboss Cache、  1. PHP Smarty...
    7. 数据库自身缓存
    8. 分布式缓存服务

#### 2.4.2 缓存性能

- 关键指标
    1. 命中率=返回正确结果数/请求缓存次数
- 缓存维护算法
    1. FIFO(first in first out)
        - 最先进入缓存的数据会被优先被清除掉以释放空间
    2. LFU(less frequently used)
        - 使用次数较少的数据会被优先被清除掉以释放空间
    3. LRU(least recently used)
        - 根据数据最后一次被使用的时间戳,清除最远使用时间戳的释放空间
    4. 其它
        - 数据具有过期时间,清理过期时间最长的元素或清理最近要过期的元素
        - 随机清理,根据关键字(或元素内容)长短清理...

### 2.5 事务处理服务

- 事务:由一组操作构成的可靠、独立的工作单元
- ACID特性
    1. Atomicity(原子性):要么全部完成,要么全部不完成
    2. Consistency(一致性):事务开始之前和事务结束以后,数据库的完整性约束没有被破坏
    3. Isolation(隔离性):事务之间是隔离的,一个事务不应该影响其它事务运行效
    4. Durability(持久性):在事务完成以后,该事务所对数据库所作的更改便持久的保存在数据库之中

- 两阶段提交协议
    1. 为了使基于分布式系统架构下的所有节点在进行事务提交时保持一致性而设计的一种算法

- 三阶段提交协议

#### 2.5.1 分布式系统的CAP定理

- 分布式系统领域的“帽子”定理
    1. 一个分布式系统最多只能同时满足一致性、可用性和分区容错性这三项中的两项

- BASE理论:
    1. 来源于对大规模互联网系统分布式实践的总结
    2. 即使无法做到强一致性,但每个应用都可以根据自身业务特点,采用适当的方式来使系统达到最终一致性间或功能上的损失
    3. asically Available
        - 在出现故障的时候允许损失部分可用性,如响应时存在不会影响整体可用性
    4. Soft state
        - 允许系统数据存在中间状态,并认为该中间状态的
    5. Eventually consistency
        - 系统保证最终数据能够达到一致,而不需要实时保证系统数据的强一致性

### 2.6 目录服务

- 通过名字检索属性的公共服务
    1. 将现实世界中事物的信息存储为具有描述性属性的对象
        - 如计算资源、软件资源、用户等等
    2. 用户可以按名称查找对象属性
- 目录服务实例
    1. DNS、Windows Active Directory、X.500、LDAP...
- 设计挑战
    1. 如何在设计上为灵活检索信息优化?
    2. 如何建立层次结构,实现广域名字管理?

### 2.7 共享存储服务

#### 2.7.1 数据中心常见的共享存储

- 磁带机
    1. 用于数据备份和“冷”数据存储
- 存储区域网络SAN
    2. 通过光纤或TCP/IP网络将磁盘阵列等存储设备联接起来
    3. “块”存储设备,不能实现数据在不同主机之间的共享
- 网络附加存储NAS
    1. 专为文件存储设计的网络服务器
- 分布式文件系统
    1. 文件并非存储在计算机本地,而是通过网络进行访问,如：NFS Network File System、Ceph
- 分布式对象存储
    1. 对象:“一次写入后基本不变,需要多次读取”的文件
        - 例如邮件附件、互联网内容分发过程中的静态资源等
        - 存储系统可以为此类文件作专门优化
        - 无需层次化的目录结构 ,直接用对象名定位
        - 无需兼容POSIX接口,无需增量修改,只需提供put、get、del等方法
- SQL数据库
    如：Mycat数据库中间件
- NoSQL/NewSQL数据库
    1. 易扩展
        - 基于非关系模型
    2. 大数据量,高性能
    3. 灵活的数据模型
        - Key-Value,列存储,文档数据库,图形数据库...
    4. 高可用
    5. 如：Hbase（Hadoop Database）数据库

### 2.8 大数据计算框架

#### 2.8.1 实例:Hadoop

- MapReduce模型
    1. “分而治之”,使之可以通过线性增加资源来提升性能
- HDFS:分布式文件系统
- MapReduce
    1. Mapper、Reducer等编程支持
    2. 运行时实例化、容错管理等
- Hbase、Hive、Pig...

#### 2.8.2 实例:Apache Storm

- 分布式实时流处理框架
