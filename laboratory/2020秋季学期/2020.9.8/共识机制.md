# 共识机制

**目标**：针对 pull request 审阅人主观设置的股权激励值，进行共识



## 外围贡献者选择算法

**目标**：选择 n 个候选人参与投票

**约束**：

- 贡献 pr 中 commit 的贡献者无法被选择

**选择算法**：

- $R(x)$：贡献者排名
- $A(x)$：用户活跃度（如代码贡献行数）
- $M(x)$：用户参与共识的次数

- $R(x)=A(x)/(M(x)+1)$：贡献者排名计算规则
- $n$：记账人数量，初始为外围贡献者的 1/10

按照 $R(x)$ 排名，从大到小选择 $2n$ 个候选人。如果存在排名重复导致只能选择 k 个候选人（k<n），则使用下面的方面选择剩下的 2n-k 个候选人

- $h_{standard}=hash(time)+username1+username2+...+usernamen$
- $h_{id}(i)=|hash(username1+R(i)-h_{standard})|$

选择最小的 2n-k 个候选人

*考虑到开源社区的场景，候选人不会经常在线，所以候选人中实际参与共识的人数为 n。成功参与共识的贡献者其 $A(x)$ 将被清零*



## 核心贡献者选择

延续现有开源社区规则：approve 大于等于 k，k 由 administrator 或 owner 设置



## 共识过程

**符号**：

- $s$：股权激励值
- $ave$：平均股权激励值
- $m$：项目要求最低 approve 数量
- $n$：记账人数量
- $up$：同意设置的平均股权激励值
- $down$：不同意设置的平均股权激励值
- $timeout$：每回合共识的超时时间

**过程**

1. 贡献者提交 pr

2. 核心贡献者 review pr，反馈意见，修改 pr，再次 review，直到满足要求。

3. 核心贡献者设置股权激励值 $s$ 并 approve

4. approve 数量大于等于 $m$，计算 $ave=(s1+...+sm)/m$，触发外围贡献者选择算法

5. 算法选择 $2n$ 个候选者参与共识，其中最多有 $n$ 张有效投票，投票按时间先后顺序生效，超过 $n$ 张投票的部分会被丢弃。

   投票有两种类型：第一种类型是 $up$，第二种类型是 $down$ 并设置合适的股权激励值 $s$

   结果有两种类型：

   1. 投 $up$ 的记账人数量大于等于 50%，此时达成共识，成功 merge
   
    	2. 投 $up$ 的记账人数量小于 50%，此时无法达成共识，回到第三步

**异常情况**：

1. 达到超时时间 $timeout$ 还没有 $n$ 张有效投票，此时触发超时事件，以有效投票为基准计算共识结果

2. 存在作恶的贡献者，故意让 pr 股权激励值无法达成共识。设置最大共识轮次 $l$，超过 $l$ 还没有达成共识，则触发算法选择新的一批候选者、记账人
3. 允许举报恶意贡献者，若同一贡献者被多次举报，将永久剥夺其参与共识的权利