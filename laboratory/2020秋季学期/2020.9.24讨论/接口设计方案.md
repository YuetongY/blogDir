[toc]

# 接口设计方案

trustie 开源社区目前需要存证和确权的数据可以分为六类，分别是 commit数据、push 数据、Pull Request 数据、Pull Request Comment 数据、Issue 数据和 Issue Coomment 数据。

- **每类数据需要存证和确权两种接口**

- **目前不考虑代码克隆检测的场景**
- **所有存证的接口都需要身份验证（签名），由平台统一将数据上链，用户无法自己上传数据**

## Commit 数据

1. **存证接口**：putCommit，参数为 json object：

   ```json
   {
   	"commit_hash": "3f2dc2ec21876d31ffa06744f215b6a17c5d3bad",
   	"author": "sulenn",
   	"email": "273409891@qq.com",
   	"time": "Mon Aug 31 23:24:28 2020 +0800",
   	"message": "fix dead lock when use AMOP broadcast with FISCO BCOS v2.6 (#71)",
   	"commit_diff": "commit3f2dc2ec21876d31ffa06744f215b6a17c5d3badAuthor:sulenn<273409891@qq.com>Date:MonAug3123:24:282020+0800fixdeadlockwhenuseAMOPbroadcastwithFISCOBCOSv2.6(#71)diff--gita/conn/channel.gob/conn/channel.goindex4882200..f5384d4100644---a/conn/channel.go+++b/conn/channel.go@@-1035,7+1035,11@@func(hc*channelSession)processMessages(){hc.mu.Lock()ifresponse,ok:=hc.responses[msg.uuid];ok{response.Message=msg-response.Notify<-struct{}{}+ifresponse.Notify!=nil{+response.Notify<-struct{}{}+close(response.Notify)+}+response.Notify=nil}hc.mu.Unlock()switchmsg.typeN{"
   }
   ```

   *json object 中关键字段描述如下*：

   | Key                                                          | Type   | Description                                        |
   | ------------------------------------------------------------ | ------ | -------------------------------------------------- |
   | commit_hash                                                  | string | 提交 commit 的 hash 值                             |
   | author                                                       | string | 提交 commit 的作者                                 |
   | email                                                        | string | 提交 commit 的邮箱                                 |
   | time                                                         | string | 提交 commit 的时间                                 |
   | content                                                      | string | 提交 commit 的标题内容                             |
   | commit_diff（git show 3f2dc2ec21876d31ffa06744f215b6a17c5d3bad） | string | 当前 commit 和上一个 commit 相比，增加和删除的内容 |

   **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=putCommit&arg=jsonObject

   **返回结果示例**：

   ```json
   {
   	"data": "{\"status\":\"Success\"}",
   	"action": "onExecuteResult",
   	"executeTime": "13"
   }
   ```

   

2. **确权接口**：getCommit，参数为 commit hash

   | Key         | Type   | Description            |
   | ----------- | ------ | ---------------------- |
   | commit_hash | string | 提交 commit 的 hash 值 |

   **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=getCommit&arg=commit_hash

   **返回结果示例**：

   ```json
   {
   	"data": {
   		"status": "Success",
   		"result": {
   			"commit_hash": "3f2dc2ec21876d31ffa06744f215b6a17c5d3bad",
   			"author": "sulenn",
   			"email": "273409891@qq.com",
   			"time": "Mon Aug 31 23:24:28 2020 +0800",
   			"message": "fix dead lock when use AMOP broadcast with FISCO BCOS v2.6 (#71)",
   			"commit_diff": "commit3f2dc2ec21876d31ffa06744f215b6a17c5d3badAuthor:sulenn<273409891@qq.com>Date:MonAug3123:24:282020+0800fixdeadlockwhenuseAMOPbroadcastwithFISCOBCOSv2.6(#71)diff--gita/conn/channel.gob/conn/channel.goindex4882200..f5384d4100644---a/conn/channel.go+++b/conn/channel.go@@-1035,7+1035,11@@func(hc*channelSession)processMessages(){hc.mu.Lock()ifresponse,ok:=hc.responses[msg.uuid];ok{response.Message=msg-response.Notify<-struct{}{}+ifresponse.Notify!=nil{+response.Notify<-struct{}{}+close(response.Notify)+}+response.Notify=nil}hc.mu.Unlock()switchmsg.typeN{"
   		}
   	},
   	"action": "onExecuteResult",
   	"executeTime": "13"
   }
   ```


## Push 数据

1. **存证接口**：putPush，参数为 json object：

   ```json
   {
   	"push_id": "00000001",
   	"reponame": "go-sdk",
   	"ownername": "qiubing",
   	"username": "sulenn",
   	"branch": "Master",
   	"size": 3,
   	"commit-sha": ["c901d1fc2400f35d8c64c03e58e8e3ea916adec9", "1093c5844458ad35e9c69f5eb6c53c11a4380c21", "de370565bebb692aee44c67761317e7600c853f4"],
   	"time": "Fri Sep 11 19:54:22 2020 +0800"
   }
   ```

   *json object 中关键字段描述如下*：

   | Key         | Type     | Description                    |
   | ----------- | -------- | ------------------------------ |
   | push_id     | string   | push 编号                      |
   | reponame    | string   | 项目名                         |
   | ownername   | string   | 项目创始用户                   |
   | username    | string   | 提交 push 的用户               |
   | branch      | string   | push 所属分支                  |
   | size        | integer  | push 中包含的 commit 数量      |
   | commit-shas | []string | push 中包含的 commit hash 列表 |
   | time        | string   | 提交 push 的时间               |

   **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=putPush&arg=jsonObject

   **返回结果示例**：

   ```json
   {
   	"data": "{\"status\":\"Success\"}",
   	"action": "onExecuteResult",
   	"executeTime": "13"
   }
   ```

2. **确权接口**：getPush，参数为 push_id、reponame、ownername

   | Key       | Type   | Description  |
   | --------- | ------ | ------------ |
   | push_id   | string | push 编号    |
   | reponame  | string | 项目名       |
   | ownername | string | 项目创始用户 |

   **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=getPush&arg=jsonObject

   **返回结果示例**：

   ```json
   {
   	"data": {
   		"status": "Success",
   		"result": {
   			"push_id": "00000001",
   			"reponame": "go-sdk",
   			"ownername": "qiubing",
   			"username": "sulenn",
   			"branch": "Master",
   			"size": 3,
   			"commit-sha": ["c901d1fc2400f35d8c64c03e58e8e3ea916adec9", "1093c5844458ad35e9c69f5eb6c53c11a4380c21", "de370565bebb692aee44c67761317e7600c853f4"],
   			"time": "Fri Sep 11 19:54:22 2020 +0800"
   		}
   	},
   	"action": "onExecuteResult",
   	"executeTime": "13"
   }
   ```

## Pull Request数据

1. **存证接口**：putPullRequest，参数为 json object：

   ```json
   {
   	"pull_request_number": "00000001",
   	"reponame": "go-sdk",
   	"ownername": "qiubing",
   	"username": "sulenn",
   	"action": "opened",
   	"title": "Add resource to Naming Routes override example",
   	"content": "Added a resource to the Naming Routes override example. Took me a while to realize that order matters, I figure having the resource in the example will help other newbies.",
   	"source_branch": "develop",
   	"target_branch": "develop",
   	"reviewers": ["lebron", "james"],
   	"commit-shas": ["c901d1fc2400f35d8c64c03e58e8e3ea916adec9", "1093c5844458ad35e9c69f5eb6c53c11a4380c21", "de370565bebb692aee44c67761317e7600c853f4"],
   	"target_branch": "develop",
   	"merge_user": "kobe",
   	"created_at": "Wed Sep 9 22:42:48 2020 +0800",
   	"updated_at": "Fri Sep 11 19:54:22 2020 +0800"
   }
   ```

   *json object 中关键字段描述如下*：

   | Key                 | Type     | Description                                                  |
| ------------------- | -------- | ------------------------------------------------------------ |
| pull_request_number | string   | pull request 编号                                            |
| reponame            | string   | 项目名                                                       |
| ownername           | string   | 项目创始用户                                                 |
| username            | string   | 提交 pull request 的用户                                     |
| action              | string   | pull request 当前状态，`opened`, `closed`, `reopened`, merge 等 |
| title               | string   | pull request 标题                                            |
| content             | string   | 提交 pull request 的内容                                     |
| source_branch       | string   | 源分支                                                       |
| target_branch       | string   | 目标分支                                                     |
| reviewers           | []string | pull request 审阅人列表                                      |
| commit-shas         | []string | pull request 中包含的 commit hash 列表                       |
| merge_user          | string   | 执行合并操作的用户                                           |
| created_at          | string   | 创建 pull request comment 的时间                             |
| updated_at          | string   | 更新 pull request comment 的时间                             |

   **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=putPullRequest&arg=jsonObject

   **返回结果示例**：

   ```json
   {
   	"data": "{\"status\":\"Success\"}",
   	"action": "onExecuteResult",
   	"executeTime": "13"
   }
   ```

2. **确权接口**：getPullRequest，参数为 pull_request_number、reponame、ownername

   | Key                 | Type   | Description       |
   | ------------------- | ------ | ----------------- |
   | pull_request_number | string | pull request 编号 |
   | reponame            | string | 项目名            |
   | ownername           | string | 项目创始用户      |

   **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=getPullRequest&arg=jsonObject

   **返回结果示例**：

   ```json
   {
   	"data": {
   		"status": "Success",
   		"result": {
   			"pull_request_number": "00000001",
   			"reponame": "go-sdk",
   			"ownername": "qiubing",
   			"username": "sulenn",
   			"action": "opened",
   			"title": "Add resource to Naming Routes override example",
   			"content": "Added a resource to the Naming Routes override example. Took me a while to realize that order matters, I figure having the resource in the example will help other newbies.",
   			"source_branch": "develop",
   			"target_branch": "develop",
   			"reviewers": ["lebron", "james"],
   			"commit-shas": ["c901d1fc2400f35d8c64c03e58e8e3ea916adec9", "1093c5844458ad35e9c69f5eb6c53c11a4380c21", "de370565bebb692aee44c67761317e7600c853f4"],
   			"target_branch": "develop",
   			"merge_user": "kobe",
   			"created_at": "Wed Sep 9 22:42:48 2020 +0800",
   			"updated_at": "Fri Sep 11 19:54:22 2020 +0800"
   		}
   	},
   	"action": "onExecuteResult",
   	"executeTime": "13"
   }
   ```

## Pull Request comment 数据

1. **存证接口**：putPullRequestComment，参数为 json object：

   ```json
   {
   	"pull_request_comment_number": "00000002",
   	"pull_request_number": "00000001",
   	"reponame": "go-sdk",
   	"ownername": "qiubing",
   	"username": "sulenn",
   	"action": "created",
   	"content": "nice tip!",
   	"created_at": "Wed Sep 9 22:42:48 2020 +0800",
   	"updated_at": "Fri Sep 11 19:54:22 2020 +0800"
   }
   ```
   
   *json object 中关键字段描述如下*：
   
   | Key                         | Type   | Description                                     |
   | --------------------------- | ------ | ----------------------------------------------- |
   | pull_request_comment_number | string | pull request comment 编号                       |
| reponame                    | string | 项目名                                          |
   | ownername                   | string | 项目创始用户                                    |
| pull_request_number         | string | pull request 编号                               |
   | username                    | string | 提交 pull request comment 的用户                |
| action                      | string | 评论的当前状态行为，created、edited、deleted 等 |
| content                     | string | 评论的内容                                      |
| created_at                  | string | 创建 pull request comment 的时间                |
| updated_at                  | string | 更新 pull request comment 的时间                |

    **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=putPullRequestComment&arg=jsonObject

    **返回结果示例**：

    ```json
    {
        "data": "{\"status\":\"Success\"}",
        "action": "onExecuteResult",
        "executeTime": "13"
    }
    ```

2. **确权接口**：getPullRequestComment，参数为 pull_request_comment_number、pull_request_number、reponame、ownername

   | Key                         | Type   | Description               |
   | --------------------------- | ------ | ------------------------- |
   | pull_request_comment_number | string | pull request comment 编号 |
   | pull_request_number         | string | pull request 编号         |
   | reponame                    | string | 项目名                    |
| ownername                   | string | 项目创始用户              |
   

    **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=getPullRequestComment&arg=jsonObject

    **返回结果示例**：

       ```json
       {
        "data": {
            "status": "Success",
            "result": {
                "pull_request_comment_number": "00000002",
                "pull_request_number": "00000001",
                "reponame": "go-sdk",
                "ownername": "qiubing",
                "username": "sulenn",
                "action": "created",
                "content": "nice tip!",
                "created_at": "Wed Sep 9 22:42:48 2020 +0800",
                "updated_at": "Fri Sep 11 19:54:22 2020 +0800"
            }
        },
        "action": "onExecuteResult",
        "executeTime": "13"
       }
       ```

## Issue 数据

1. **存证接口**：putIssue，参数为 json object：

   ```json
   {
   	"issue_number": "00000002",
   	"pull_request_number": "00000001",
   	"reponame": "go-sdk",
   	"ownername": "qiubing",
   	"username": "sulenn",
   	"action": "opened",
   	"title": "Issue creating fixtures ActiveRecord::FixtureSet",
   	"content": "after update from rails 5 to 6 and only running rspec",
   	"created_at": "Wed Sep 9 22:42:48 2020 +0800",
   	"updated_at": "Fri Sep 11 19:54:22 2020 +0800"
   }
   ```

   *json object 中关键字段描述如下*：

   | Key          | Type   | Description                                       |
| ------------ | ------ | ------------------------------------------------- |
| issue_number | string | issue 编号                                        |
| reponame     | string | 项目名                                            |
| ownername    | string | 项目创始用户                                      |
| username     | string | 提交 isuue 的用户                                 |
| action       | string | issue 当前状态，`opened`, `closed`, `reopened` 等 |
| title        | string | issue 标题                                        |
| content      | string | 提交 issue 的内容                                 |
| created_at   | string | 创建 issue 的时间                                 |
| updated_at   | string | 更新 issue 的时间                                 |

   **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=putIssue&arg=jsonObject

   **返回结果示例**：

   ```json
   {
   	"data": "{\"status\":\"Success\"}",
   	"action": "onExecuteResult",
   	"executeTime": "13"
   }
   ```

2. **确权接口**：getIssue，参数为 issue_number、reponame、ownername

   | Key          | Type   | Description  |
   | ------------ | ------ | ------------ |
   | issue_number | string | issue 编号   |
   | reponame     | string | 项目名       |
   | ownername    | string | 项目创始用户 |
   
   **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=getIssue&arg=jsonObject
   
   **返回结果示例**：

    ```json
       {
        "data": {
            "status": "Success",
            "result": {
                "issue_number": "00000002",
                "pull_request_number": "00000001",
                "reponame": "go-sdk",
                "ownername": "qiubing",
                "username": "sulenn",
                "action": "opened",
                "title": "Issue creating fixtures ActiveRecord::FixtureSet",
                "content": "after update from rails 5 to 6 and only running rspec",
                "created_at": "Wed Sep 9 22:42:48 2020 +0800",
                "updated_at": "Fri Sep 11 19:54:22 2020 +0800"
            }
        },
        "action": "onExecuteResult",
        "executeTime": "13"
       }
    ```

## Issue comment 数据

1. **存证接口**：putIssueComment，参数为 json object：

   ```json
   {
   	"issue_comment_number": "00000002",
   	"issue_number": "00000001",
   	"reponame": "go-sdk",
   	"ownername": "qiubing",
   	"username": "sulenn",
   	"action": "created",
   	"content": "nice tip!",
   	"created_at": "Wed Sep 9 22:42:48 2020 +0800",
   	"updated_at": "Fri Sep 11 19:54:22 2020 +0800"
   }
   ```
   

    *json object 中关键字段描述如下*：

   | Key                  | Type    | Description                                     |
   | -------------------- | ------- | ----------------------------------------------- |
   | issue_comment_number | string  | issue comment 编号                              |
   | reponame             | string  | 项目名                                          |
   | ownername            | string  | 项目创始用户                                    |
   | issue_number         | integer | issue 编号                                      |
   | username             | string  | 提交 issue comment 的用户                       |
   | action               | string  | 评论的当前状态行为，created、edited、deleted 等 |
   | content              | string  | 评论的内容                                      |
   | created_at           | string  | 创建 issue comment 的时间                       |
   | updated_at           | string  | 更新 issue comment 的时间                       |

    **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=putIssueComment&arg=jsonObject

    **返回结果示例**：

    ```json
       {
        "data": "{\"status\":\"Success\"}",
        "action": "onExecuteResult",
        "executeTime": "13"
       }
    ```

2. **确权接口**：getIssueComment，参数为 issue_comment_number、issue_number、reponame、ownername

   | Key                  | Type   | Description        |
   | -------------------- | ------ | ------------------ |
   | issue_comment_number | string | issue comment 编号 |
   | issue_number         | string | issue 编号         |
   | reponame             | string | 项目名             |
| ownername            | string | 项目创始用户       |
   

    **HTTP 请求示例**：http://127.0.0.1:1717/SCIDE/SCManager?action=executeContract&contractID=-620602333&operation=getIssueComment&arg=jsonObject

    **返回结果示例**：

       ```json
       {
        "data": {
            "status": "Success",
            "result": {
                "issue_comment_number": "00000002",
                "issue_number": "00000001",
                "reponame": "go-sdk",
                "ownername": "qiubing",
                "username": "sulenn",
                "action": "created",
                "content": "nice tip!",
                "created_at": "Wed Sep 9 22:42:48 2020 +0800",
                "updated_at": "Fri Sep 11 19:54:22 2020 +0800"
            }
        },
        "action": "onExecuteResult",
        "executeTime": "13"
       }
       ```



