# 【提测】极端异常下的共识恢复应急方案

## 提测项目：FISCO BCOS

GIT地址：https://github.com/FISCO-BCOS/FISCO-BCOS

GIT分支：dev

## 提测文档

极端异常下的共识恢复应急方案：http://note.youdao.com/noteshare?id=a402c125a9e830d301ca29f4fcc7e911

## 测试功能点

**测试功能点问题背景**：FISCO BCOS 支持的 [PBFT 共识算法](https://fisco-bcos-documentation.readthedocs.io/zh_CN/latest/docs/design/consensus/pbft.html) 需要区块链网络中至少存在 `2*f+1` 个共识节点正常工作（假定总节点数为 `3*f+1` ）才能维持网络的良性运转。但是实际生产环境中往往会出现各种特殊情况，如网络脑裂、节点网络中断、节点硬件崩溃，从而导致网络中节点数量少于 `2*f+1`，这时网络将无法对交易和区块达成共识，网络陷入瘫痪。

**测试功能点目标**：测试 “极端异常下的共识恢复应急方案” 的可行性

**测试功能点方案**：手动关闭正常共识节点，修改正常共识节点数据库 `_sys_consensus_` 表中的异常共识节点信息，将异常共识节点的 type 字段值从 sealer 修改为 observer，也就是手动将异常共识节点修改为观察者节点，然后启动正常共识节点。

因为FISCO BCOS 支持不同的数据库存储模式，不同的数据库模式在操作和存储方面存在差异。所以需要分别测试Mysql 和 RocksDB 数据库存储模式。

### 1. 测试Mysql存储模式

1. **本地启动单群组4节点网络**：注意选择mysql存储模式，然后使用控制台或者sdk，让块高到达10；
2. **关闭节点C和节点D**：模拟节点C和节点D异常崩溃。此时网络不满 PBFT 共识条件，网络瘫痪。下面的步骤就是网络异常之后，如何让网络恢复的方案；
3. **关闭节点A和节点B**：为了防止操作数据库给正在运行的网络造成影响，建议先关闭节点A和节点B；
4. **手动修改节点A和节点B的数据库**：确保A、B、C、D节点块高一致的前提下修改节点A和节点B数据库中 `_sys_consensus_` 表，将节点C和节点D的 type 字段值从 sealer 修改为 observer；
5. **启动节点A和节点B**：重启节点之后，网络中共识节点只有节点A和节点B，满足 PBFT 共识条件，网络可正常共识打包出块；
6. **手动修改节点C和节点D的数据库**：修改节点C和节点D中数据库 `_sys_consensus_` 表，将节点C和节点D的 type 字段值从 sealer 修改为 observer；
7. **启动节点C和节点D**：节点C和节点D作为观察者节点，可以顺利同步区块，但无法参与网络共识；
8. **添加共识节点**：通过控制台调用 addSealer 命令，将节点C和节点D转换为共识节点。

**详细步骤请参考提测文档**

### 2. 测试RocksDB存储模式

大致测试步骤同上

1. **本地启动单群组4节点网络**：注意选择rocksdb存储模式，然后使用控制台或者sdk，让快高到达10；
2. **关闭节点C和节点D**：模拟节点C和节点D异常崩溃。此时网络不满 PBFT 共识条件，网络瘫痪。下面的步骤就是网络异常之后，如何让网络恢复的方案；
3. **获取rocksdb-storage工具**：编译 [FISCO BCOS源码](https://github.com/FISCO-BCOS/FISCO-BCOS) 获取 rocksdb-storage 工具，使用该工具查询、修改 rocksdb 数据库中信息；
4. **关闭节点A和节点B**：为了防止操作数据库给正在运行的网络造成影响，建议先关闭节点A和节点B；
5. **手动修改节点A和节点B的数据库**：确保A、B、C、D节点块高一致的前提下修改节点A和节点B数据库中 `_sys_consensus_` 表，将节点C和节点D的 type 字段值从 sealer 修改为 observer；
6. **启动节点A和节点B**：启动节点之后，网络中共识节点只有节点A和节点B，满足 PBFT 共识条件，网络可正常共识打包出块；
7. **手动修改节点C和节点D的数据库**：修改节点C和节点D中数据库 `_sys_consensus_` 表，将节点C和节点D的 type 字段值从 sealer 修改为 observer；
8. **启动节点C和节点D**：节点C和节点D作为观察者节点，可以顺利同步区块，但无法参与网络共识；
9. **添加共识节点**：通过控制台调用 addSealer 命令，将节点C和节点D转换为共识节点。

**详细步骤请参考提测文档**